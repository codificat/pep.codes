<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Pep Turró Mauri]"><meta name=description content="I have been running Emacs in server mode for a while. Until recently, my workflow was:
start emacs M-x server-start Following the blog post (Schwartzmeyer 2021), from now on I will try to start Emacs directly server mode, managed by systemd:
systemctl --user enable --now emacs journalctl --user-unit emacs Fixing the systemd unit Enabling the systemd unit initially failed:
pep@uio ~ $ systemctl --user enable emacs Failed to enable unit: Unit file /home/pep/."><meta name=keywords content=",emacs,systemd"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=http://pep.codes/posts/emacs-systemd/><title>Running Emacs in server mode :: Pep Codes — A work in progress home page</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.5.0/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.4e5c639214707eff609bb55fe49e183dee42258a73bc90e4cc7b0a84f900798a.css><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><meta name=msapplication-TileColor content><meta itemprop=name content="Running Emacs in server mode"><meta itemprop=description content="I have been running Emacs in server mode for a while. Until recently, my workflow was:
start emacs M-x server-start Following the blog post (Schwartzmeyer 2021), from now on I will try to start Emacs directly server mode, managed by systemd:
systemctl --user enable --now emacs journalctl --user-unit emacs Fixing the systemd unit Enabling the systemd unit initially failed:
pep@uio ~ $ systemctl --user enable emacs Failed to enable unit: Unit file /home/pep/."><meta itemprop=datePublished content="2022-12-09T21:52:00+01:00"><meta itemprop=dateModified content="2022-12-09T21:52:00+01:00"><meta itemprop=wordCount content="369"><meta itemprop=image content="http://pep.codes/"><meta itemprop=keywords content="emacs,systemd,"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://pep.codes/"><meta name=twitter:title content="Running Emacs in server mode"><meta name=twitter:description content="I have been running Emacs in server mode for a while. Until recently, my workflow was:
start emacs M-x server-start Following the blog post (Schwartzmeyer 2021), from now on I will try to start Emacs directly server mode, managed by systemd:
systemctl --user enable --now emacs journalctl --user-unit emacs Fixing the systemd unit Enabling the systemd unit initially failed:
pep@uio ~ $ systemctl --user enable emacs Failed to enable unit: Unit file /home/pep/."><meta property="og:title" content="Running Emacs in server mode"><meta property="og:description" content="I have been running Emacs in server mode for a while. Until recently, my workflow was:
start emacs M-x server-start Following the blog post (Schwartzmeyer 2021), from now on I will try to start Emacs directly server mode, managed by systemd:
systemctl --user enable --now emacs journalctl --user-unit emacs Fixing the systemd unit Enabling the systemd unit initially failed:
pep@uio ~ $ systemctl --user enable emacs Failed to enable unit: Unit file /home/pep/."><meta property="og:type" content="article"><meta property="og:url" content="http://pep.codes/posts/emacs-systemd/"><meta property="og:image" content="http://pep.codes/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-09T21:52:00+01:00"><meta property="article:modified_time" content="2022-12-09T21:52:00+01:00"><meta property="og:site_name" content="Pep Codes"><meta property="article:published_time" content="2022-12-09 21:52:00 +0100 +0100"></head><body><div class=container><header class=header><span class=header__inner><a href=/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
<span class=logo__text>pep.codes</span>
<span class=logo__cursor></span></div></a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=/posts>Blog</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span></span></span></header><div class=content><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2 minutes</p></div><article><h1 class=post-title><a href=http://pep.codes/posts/emacs-systemd/>Running Emacs in server mode</a></h1><div class=post-content><p>I have been running Emacs in server mode for a while. Until recently, my workflow was:</p><ol><li>start emacs</li><li><code>M-x server-start</code></li></ol><p>Following the blog post (<a href=#citeproc_bib_item_1>Schwartzmeyer 2021</a>), from now on I will try
to start Emacs directly server mode, managed by systemd:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>systemctl --user enable --now emacs
</span></span><span style=display:flex><span>journalctl --user-unit emacs
</span></span></code></pre></div><h2 id=fixing-the-systemd-unit>Fixing the systemd unit</h2><p>Enabling the systemd unit initially failed:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pep@uio ~ $ systemctl --user enable emacs
</span></span><span style=display:flex><span>Failed to enable unit: Unit file /home/pep/.config/systemd/user/default.target.wants/emacs.service does not exist.
</span></span></code></pre></div><p>Quickly fixed with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pep@uio user (master) $ mkdir -p ~/.config/systemd/user/default.target.wants
</span></span><span style=display:flex><span>pep@uio user (master) $ systemctl --user enable emacs
</span></span><span style=display:flex><span>Created symlink /home/pep/.config/systemd/user/default.target.wants/emacs.service → /usr/lib/systemd/user/emacs.service.
</span></span></code></pre></div><p>with the following contents:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span>[<span style=color:#a6e22e>Unit</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Description</span>=<span style=color:#a6e22e>Emacs</span> <span style=color:#a6e22e>text</span> <span style=color:#a6e22e>editor</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Documentation</span>=<span style=color:#a6e22e>info</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>emacs</span> <span style=color:#a6e22e>man</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#a6e22e>emacs</span><span style=color:#960050;background-color:#1e0010>(</span><span style=color:#ae81ff>1</span><span style=color:#960050;background-color:#1e0010>)</span> <span style=color:#a6e22e>https</span><span style=color:#960050;background-color:#1e0010>://</span><span style=color:#a6e22e>gnu</span>.<span style=color:#a6e22e>org</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>software</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>emacs</span><span style=color:#960050;background-color:#1e0010>/</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Service</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>Type</span>=<span style=color:#a6e22e>notify</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ExecStart</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>emacs</span> <span style=color:#a6e22e>--fg-daemon</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Emacs will exit with status 15 after having received SIGTERM, which</span>
</span></span><span style=display:flex><span><span style=color:#75715e># is the default &#34;KillSignal&#34; value systemd uses to stop services.</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>SuccessExitStatus</span>=<span style=color:#ae81ff>15</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># The location of the SSH auth socket varies by distribution, and some</span>
</span></span><span style=display:flex><span><span style=color:#75715e># set it from PAM, so don&#39;t override by default.</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Environment=SSH_AUTH_SOCK=%t/keyring/ssh</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>Restart</span>=<span style=color:#a6e22e>on-failure</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[<span style=color:#a6e22e>Install</span>]
</span></span><span style=display:flex><span><span style=color:#a6e22e>WantedBy</span>=<span style=color:#a6e22e>default</span>.<span style=color:#a6e22e>target</span>
</span></span></code></pre></div><h2 id=safe-shutdown>Safe shutdown</h2><p>Then, what about open files when closing?</p><p>Building upon <a href=https://www.emacswiki.org/emacs/EmacsAsDaemon#h5o-2>EmacsWiki docs for systemd</a> I believe I should modify the systemd unit to include something like:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=display:flex><span><span style=color:#a6e22e>ExecStop</span>=<span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>usr</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#a6e22e>emacsclient</span> <span style=color:#a6e22e>--eval</span> <span style=color:#e6db74>&#34;(save-buffers-kill-emacs)&#34;</span>
</span></span></code></pre></div><p>but I need to finalize some doubts, like setting <code>confirm-kill-process</code>.</p><h2 id=checking-status>Checking status</h2><p>After starting it with <code>systemctl --user start emacs</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pep@uio ~ $ systemctl --user status emacs
</span></span><span style=display:flex><span>● emacs.service - Emacs text editor
</span></span><span style=display:flex><span>     Loaded: loaded (/usr/lib/systemd/user/emacs.service; disabled; vendor preset: disabled)
</span></span><span style=display:flex><span>     Active: active (running) since Thu 2022-11-24 12:40:42 CET; 21min ago
</span></span><span style=display:flex><span>       Docs: info:emacs
</span></span><span style=display:flex><span>             man:emacs(1)
</span></span><span style=display:flex><span>             https://gnu.org/software/emacs/
</span></span><span style=display:flex><span>   Main PID: 43673 (emacs)
</span></span><span style=display:flex><span>      Tasks: 8 (limit: 38145)
</span></span><span style=display:flex><span>     Memory: 516.1M
</span></span><span style=display:flex><span>        CPU: 44.767s
</span></span><span style=display:flex><span>     CGroup: /user.slice/user-1000.slice/user@1000.service/app.slice/emacs.service
</span></span><span style=display:flex><span>             ├─ 43673 /usr/bin/emacs --fg-daemon
</span></span><span style=display:flex><span>             ├─ 43677 /home/pep/.emacs.d/elpa/emacsql-sqlite-20221024.1455/sqlite/emacsql-sqlite /home/pep/.emacs.d/org-roam.db
</span></span><span style=display:flex><span>             ├─ 43710 /home/pep/.emacs.d/elpa/pdf-tools-20221007.1404/epdfinfo
</span></span><span style=display:flex><span>             ├─ 43946 /usr/bin/mu server
</span></span><span style=display:flex><span>             └─ 46975 /usr/bin/sh -i
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>de nov. 24 12:40:42 uio systemd[2978]: Started emacs.service - Emacs text editor.
</span></span></code></pre></div><h2 id=updating-client-configuration>Updating client configuration</h2><p>I have updated my i3wm configuration so that <code>S-b</code> will create a new emacs
frame:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>$ grep -i emacs .config/i3/config
</span></span><span style=display:flex><span># open a new emacs frame
</span></span><span style=display:flex><span>bindsym $mod+b exec --no-startup-id emacsclient -c
</span></span></code></pre></div><p>So, now, opening Emacs after logging in is just one keyboard shortcut away.</p><p>Also updated aliases related to <code>emacsclient</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>alias e<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;emacsclient&#39;</span>
</span></span><span style=display:flex><span>alias et<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;emacsclient -t&#39;</span>  <span style=color:#75715e># for staying in the terminal</span>
</span></span></code></pre></div><h2 id=references>References</h2><style>.csl-entry{text-indent:-1.5em;margin-left:1.5em}</style><div class=csl-bib-body><div class=csl-entry><a id=citeproc_bib_item_1></a>Schwartzmeyer, Andy. 2021. “Emacs on an iPad.” <a href=https://andschwa.com/posts/emacs-on-an-ipad/>https://andschwa.com/posts/emacs-on-an-ipad/</a>.</div></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=http://pep.codes/tags/emacs/>emacs</a></span>
<span class=tag><a href=http://pep.codes/tags/systemd/>systemd</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>369 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-12-09 20:52</p></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=http://pep.codes/posts/advent-of-elisp/><span class=button__icon>←</span>
<span class=button__text>Advent of Emacs Lisp</span></a></span></div></div></main></div><footer class=footer><div class=footer__inner><div class=footer__content><span>&copy; 2022</span>
<span><a href=http://pep.codes/>Pep Turró Mauri</a></span>
<span><a href=https://creativecommons.org/licenses/by-sa/4.0/ target=_blank rel=noopener>CC BY-SA 4.0</a></span>
<span><a href=http://pep.codes/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div></div><div class=footer__inner><div class=footer__content><span>Powered by <a href=https://www.gnu.org/software/emacs/>Emacs</a> & <a href=https://gohugo.io>Hugo</a></span><span><a href=https://github.com/rhazdon/hugo-theme-hello-friend-ng>Hello Friend NG</a> theme</span></div></div></footer></div><script type=text/javascript src=/bundle.min.bb2c6bc3ed452ca4759660e4020811f248bc2320081559e8a32d8b0092773852941133639d35e8370d03d3ddaa750b1edd6b343c5bd22a55d5bdeae8f648f49b.js integrity="sha512-uyxrw+1FLKR1lmDkAggR8ki8IyAIFVnooy2LAJJ3OFKUETNjnTXoNw0D092qdQse3Ws0PFvSKlXVvero9kj0mw=="></script></body></html>